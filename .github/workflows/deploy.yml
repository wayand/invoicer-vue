name: Deploy Vue App to Hetzner

on:
    push:
        branches:
            - master


jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
              node-version: '23'

        - name: Install dependencies
          run: npm ci

        - name: Build the Vue app
          run: npm run build

        - name: Set up SSH
          run: |
            mkdir -p ~/.ssh
            echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519
            ssh-keyscan -H ${{ secrets.HETZNER_IP_ADDRESS }} >> ~/.ssh/known_hosts

        - name: Copy files via rsync
          run: rsync -avz --delete dist/* www-data@${{ secrets.HETZNER_IP_ADDRESS }}:/srv/docker/invoicer/invoicer-vue/

        - name: Run deploy script
          run: ssh www-data@${{ secrets.HETZNER_IP_ADDRESS }} "bash /srv/docker/invoicer/deploy.sh"
